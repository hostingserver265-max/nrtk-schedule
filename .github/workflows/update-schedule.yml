name: Update Schedule

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å
on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 07:00 –∏ 13:00 –ø–æ –ú–æ—Å–∫–≤–µ (04:00 –∏ 10:00 UTC)
    - cron: '0 4,10 * * *'

  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∫–Ω–æ–ø–∫—É
  workflow_dispatch:

  # –ü—Ä–∏ –ø—É—à–µ –≤ main —Ç–æ–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (–¥–ª—è —Ç–µ—Å—Ç–∞)
  push:
    branches: [ main ]

# –ü—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–≤–∞–∂–Ω–æ –¥–ª—è git push)
permissions:
  contents: write

jobs:
  update-schedule:
    runs-on: ubuntu-latest

    steps:
    # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    - name: üì¶ Checkout repository
      uses: actions/checkout@v3

    # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python 3.10
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: üìö Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    # –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä
    - name: üöÄ Parse schedule
      run: |
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª)
        rm -f schedule.json
        echo "üóëÔ∏è –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª schedule.json —É–¥–∞–ª–µ–Ω (–µ—Å–ª–∏ –±—ã–ª)"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç, –æ–Ω —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –Ω—É–ª—è
        python parse_schedule.py

    # –®–∞–≥ 5: –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    - name: üíæ Commit and push changes
      run: |
        git config --global user.name 'Schedule Bot'
        git config --global user.email 'bot@nrtk.schedule'
        
        # –ü–†–û–í–ï–†–ö–ê: –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª? (–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–∫–∏ pathspec)
        if [ -f schedule.json ]; then
          git add schedule.json
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –ª–∏ –Ω–æ–≤—ã–π —Ñ–∞–π–ª –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
          if git diff --staged --quiet; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–∫–æ–µ –∂–µ, –∫–∞–∫ –±—ã–ª–æ."
          else
            git commit -m "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "‚úÖ –£—Ä–∞! –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ GitHub."
          fi
        else
          echo "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª schedule.json –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º!"
          echo "–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —à–∞–≥–∞ 'Parse schedule' –≤—ã—à–µ."
          exit 1
        fi
