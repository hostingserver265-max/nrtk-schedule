name: Update Schedule

on:
  schedule:
    - cron: '0 4,10 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-schedule:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout repository
      uses: actions/checkout@v3

    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: üìö Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: üöÄ Parse schedule
      run: |
        rm -f schedule.json
        echo "üóëÔ∏è –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª schedule.json —É–¥–∞–ª–µ–Ω"
        python parse_schedule.py

    - name: üíæ Commit and push changes
      run: |
        git config --global user.name 'Schedule Bot'
        git config --global user.email 'bot@nrtk.schedule'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
        if [ -f schedule.json ]; then
          git add schedule.json
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          if git diff --staged --quiet; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–µ–Ω—è–ª–æ—Å—å."
          else
            # –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ —Å –∫–∞–≤—ã—á–∫–∞–º–∏
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M')
            
            git commit -m "Update schedule $TIMESTAMP"
            
            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            git pull origin main --rebase
            git push origin main
            echo "‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!"
          fi
        else
          echo "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª schedule.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
