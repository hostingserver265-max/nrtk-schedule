name: Update Schedule

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç (–≤ 00 –∏ 30 –º–∏–Ω—É—Ç –∫–∞–∂–¥–æ–≥–æ —á–∞—Å–∞)
    - cron: '*/30 * * * *'

  # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –Ω–∞–∂–∞—Ç—å Run workflow)
  workflow_dispatch:

  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
  push:
    branches: [ main ]

# –î–∞–µ–º –ø—Ä–∞–≤–∞ –±–æ—Ç—É –Ω–∞ –∑–∞–ø–∏—Å—å —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
permissions:
  contents: write

jobs:
  update-schedule:
    runs-on: ubuntu-latest

    steps:
    # 1. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: üì¶ Checkout repository
      uses: actions/checkout@v3

    # 2. –°—Ç–∞–≤–∏–º Python
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. –°—Ç–∞–≤–∏–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (pdfplumber, requests)
    - name: üìö Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    # 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–≤–æ–π —Å–∫—Ä–∏–ø—Ç
    - name: üöÄ Parse schedule
      run: |
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π json –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–µ–∂–∏–π
        rm -f schedule.json
        
        # –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞
        python parse_schedule.py

    # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ GitHub
    - name: üíæ Commit and push changes
      run: |
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–º–µ–Ω–∏ –±–æ—Ç–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        git config --global user.name 'Schedule Bot'
        git config --global user.email 'bot@nrtk.schedule'
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–µ—Ä–∞)
        if [ -f schedule.json ]; then
          git add schedule.json
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
          if git diff --staged --quiet; then
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç. –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –ø–æ–º–µ–Ω—è–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—á–µ–≥–æ."
          else
            # –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å –¥–∞—Ç–æ–π (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫ —Å –∫–∞–≤—ã—á–∫–∞–º–∏)
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M')
            
            git commit -m "Update schedule $TIMESTAMP"
            
            # –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞ (rebase), —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            git pull origin main --rebase
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git push origin main
            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ! –ù–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ GitHub."
          fi
        else
          echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –§–∞–π–ª schedule.json –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω!"
          exit 1
        fi
